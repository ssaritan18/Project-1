<!DOCTYPE html>
<html>
<head>
    <title>Debug Auth & Upload</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a2e; color: white; }
        button { padding: 10px 20px; margin: 10px; background: #8B5CF6; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .result { margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; }
        input[type="file"] { margin: 10px 0; padding: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Auth & Upload Debug</h1>
    
    <button onclick="checkAuth()">1. Check Authentication</button>
    <button onclick="testBackend()">2. Test Backend Connection</button>
    
    <br><br>
    <input type="file" id="fileInput" accept="image/*,video/*">
    <button onclick="testUploadWithAuth()">3. Test Upload with Auth Debug</button>
    
    <div id="result"></div>

    <script>
        function log(message) {
            document.getElementById('result').innerHTML += `<div>${message}</div>`;
            console.log(message);
        }
        
        function clear() {
            document.getElementById('result').innerHTML = '';
        }

        async function checkAuth() {
            clear();
            log('ğŸ” Checking authentication...');
            
            // Check localStorage (React Native AsyncStorage becomes localStorage in web)
            const token = localStorage.getItem('token');
            log(`ğŸ”‘ Token in localStorage: ${token ? 'Found âœ…' : 'Not found âŒ'}`);
            
            if (token) {
                log(`ğŸ”‘ Token length: ${token.length} characters`);
                log(`ğŸ”‘ Token starts with: ${token.substring(0, 20)}...`);
            }
            
            // Check if user is logged in by testing /api/me endpoint
            try {
                const response = await fetch('https://focus-social.preview.emergentagent.com/api/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    log(`âœ… User authenticated: ${user.name || user.email || 'Unknown'}`);
                } else {
                    log(`âŒ Authentication failed: ${response.status} - ${response.statusText}`);
                }
            } catch (error) {
                log(`ğŸ’¥ Auth check error: ${error.message}`);
            }
        }

        async function testBackend() {
            log('ğŸŒ Testing backend connection...');
            
            try {
                const response = await fetch('https://focus-social.preview.emergentagent.com/api/');
                log(`âœ… Backend connection: ${response.status} - ${response.ok ? 'OK' : 'Error'}`);
            } catch (error) {
                log(`âŒ Backend connection failed: ${error.message}`);
            }
        }

        async function testUploadWithAuth() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                log('âš ï¸ Please select a file first');
                return;
            }

            log(`ğŸ“ File selected: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
            
            const token = localStorage.getItem('token');
            log(`ğŸ”‘ Using token: ${token ? 'Found' : 'Not found'}`);

            const formData = new FormData();
            formData.append('file', file);

            try {
                log('ğŸ“¤ Starting upload test...');
                
                const response = await fetch('https://focus-social.preview.emergentagent.com/api/chats/test_chat_id/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                log(`ğŸ“¡ Response status: ${response.status}`);
                log(`ğŸ“¡ Response headers: ${JSON.stringify([...response.headers.entries()])}`);

                if (response.ok) {
                    const result = await response.json();
                    log(`ğŸ‰ Upload successful: ${JSON.stringify(result)}`);
                } else {
                    let errorText;
                    try {
                        const errorJson = await response.json();
                        errorText = JSON.stringify(errorJson);
                    } catch {
                        errorText = await response.text();
                    }
                    log(`âŒ Upload failed (${response.status}): ${errorText}`);
                }

            } catch (error) {
                log(`ğŸ’¥ Upload error: ${error.message}`);
            }
        }

        // Auto-run on page load
        window.onload = function() {
            log('ğŸš€ Debug page loaded');
            setTimeout(checkAuth, 1000);
        };
    </script>
</body>
</html>